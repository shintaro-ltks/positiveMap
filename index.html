// Firebase設定部分の修正版
// HTMLファイルの <script> タグ内の該当部分を以下に置き換えてください

// Firebase初期化
let app, db, auth;
let isFirebaseConnected = false;

// Firebase設定（あなたの設定に置き換えてください）
const firebaseConfig = {
    apiKey: "あなたのAPIキー",
    authDomain: "あなたのプロジェクトID.firebaseapp.com",
    projectId: "あなたのプロジェクトID",
    storageBucket: "あなたのプロジェクトID.appspot.com",
    messagingSenderId: "あなたのセンダーID",
    appId: "あなたのアプリID"
};

try {
    app = firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
    
    // Firestore設定を追加
    db.settings({
        cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED
    });
    
    // オフライン永続化を有効化
    db.enablePersistence().catch((err) => {
        if (err.code == 'failed-precondition') {
            console.log('複数のタブが開いています');
        } else if (err.code == 'unimplemented') {
            console.log('ブラウザがオフライン永続化をサポートしていません');
        }
    });
    
    isFirebaseConnected = true;
    console.log('Firebase接続成功');
} catch (error) {
    console.warn('Firebase接続失敗、ローカルモードで動作:', error);
    isFirebaseConnected = false;
}

// リアルタイムリスナー設定（修正版）
function setupRealtimeListeners() {
    if (!isFirebaseConnected) return;

    try {
        // 投稿のリアルタイム監視（エラーハンドリング強化）
        realtimeListener = db.collection('posts')
            .orderBy('timestamp', 'desc')
            .limit(50)
            .onSnapshot({
                // オフラインデータも含める
                includeMetadataChanges: true
            }, (snapshot) => {
                if (snapshot.metadata.fromCache) {
                    console.log('キャッシュからデータを読み込み');
                } else {
                    console.log('サーバーからデータを読み込み');
                }

                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'added') {
                        const post = { 
                            id: change.doc.id, 
                            ...change.doc.data(),
                            // timestampの型変換
                            timestamp: change.doc.data().timestamp?.toDate?.() || change.doc.data().timestamp || Date.now()
                        };
                        
                        // 重複チェック
                        if (!allPosts.find(p => p.id === post.id)) {
                            allPosts.unshift(post);
                            addNewPostToFeed(post);
                            addPostToMap(post);
                            updateStatistics();
                            showUpdateIndicator(post.emotion);
                        }
                    }
                });
            }, (error) => {
                console.error('リアルタイム監視エラー:', error);
                
                // エラーの種類によって対処を変える
                if (error.code === 'permission-denied') {
                    showAlert('データベースの権限設定を確認してください', 'error');
                    // ローカルモードにフォールバック
                    isFirebaseConnected = false;
                    loadLocalData();
                } else if (error.code === 'unavailable') {
                    showAlert('ネットワーク接続を確認してください', 'warning');
                } else {
                    showAlert('リアルタイム更新でエラーが発生しました', 'warning');
                }
            });
    } catch (error) {
        console.error('リスナー設定エラー:', error);
        showAlert('リアルタイム機能の初期化に失敗しました', 'error');
    }
}

// 投稿送信関数（修正版）
async function submitPost() {
    if (!selectedEmotion || !userLocation) {
        showAlert(translations[currentLang].post_error || "投稿に失敗しました", 'error');
        return;
    }

    const submitBtn = document.getElementById('submitPostBtn');
    submitBtn.classList.add('btn-loading');
    submitBtn.disabled = true;
    submitBtn.textContent = "投稿中...";

    try {
        const message = document.getElementById('postMessage').value.trim();
        const now = new Date();

        const post = {
            emotion: selectedEmotion,
            message: message,
            location: {
                lat: userLocation.lat,
                lng: userLocation.lng
            },
            // Firestore Timestamp形式で保存
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            country: await getCountryFromCoords(userLocation.lat, userLocation.lng),
            language: currentLang,
            // クライアント側タイムスタンプも保存（フォールバック用）
            clientTimestamp: now.getTime(),
            userAgent: navigator.userAgent.substring(0, 100) // デバッグ用
        };

        if (isFirebaseConnected) {
            try {
                // Firestoreに保存
                const docRef = await db.collection('posts').add(post);
                console.log('投稿成功:', docRef.id);
                
                // 統計更新
                await updateGlobalStatistics({
                    ...post,
                    id: docRef.id,
                    timestamp: now.getTime() // 統計用にはJavaScript時刻を使用
                });
                
            } catch (firestoreError) {
                console.error('Firestore保存エラー:', firestoreError);
                
                if (firestoreError.code === 'permission-denied') {
                    throw new Error('データベースの権限設定に問題があります');
                } else {
                    throw firestoreError;
                }
            }
        } else {
            // ローカルストレージに保存
            const localPost = {
                ...post,
                id: generateId(),
                timestamp: now.getTime()
            };
            savePostLocally(localPost);
            addPostToMap(localPost);
            addNewPostToFeed(localPost);
            updateStatistics();
        }

        showAlert(translations[currentLang].post_success || "投稿が世界に共有されました！", 'success');
        resetPostForm();
        
        setTimeout(() => {
            showScreen('homeScreen');
        }, 2000);

    } catch (error) {
        console.error('投稿エラー:', error);
        showAlert(error.message || translations[currentLang].post_error || "投稿に失敗しました", 'error');
    } finally {
        submitBtn.classList.remove('btn-loading');
        submitBtn.disabled = false;
        checkFormValidity();
    }
}

// Firebaseデータ読み込み（修正版）
async function loadFirebaseData() {
    if (!isFirebaseConnected) {
        loadLocalData();
        return;
    }

    try {
        console.log('Firebaseからデータを読み込み中...');
        
        // 投稿データ読み込み
        const postsSnapshot = await db.collection('posts')
            .orderBy('timestamp', 'desc')
            .limit(100)
            .get();

        allPosts = [];
        postsSnapshot.forEach(doc => {
            const data = doc.data();
            const post = { 
                id: doc.id, 
                ...data,
                // Firestore Timestampを JavaScript Dateに変換
                timestamp: data.timestamp?.toDate?.()?.getTime() || data.clientTimestamp || Date.now()
            };
            allPosts.push(post);
            addPostToMap(post);
        });

        console.log(`${allPosts.length}件の投稿を読み込みました`);
        
        updateStatistics();
        updateRealtimeFeed();
        updateDataAnalytics();

    } catch (error) {
        console.error('Firebase データ読み込みエラー:', error);
        
        if (error.code === 'permission-denied') {
            showAlert('データベースの権限設定を確認してください。ローカルモードで動作します。', 'warning');
            isFirebaseConnected = false;
        } else {
            showAlert('データの読み込みに失敗しました。ローカルモードで動作します。', 'warning');
        }
        
        loadLocalData(); // フォールバック
    }
}

// 接続状態監視（修正版）
function monitorConnection() {
    const connectionStatus = document.getElementById('connectionStatus');
    const connectionText = document.getElementById('connectionText');
    
    if (isFirebaseConnected) {
        // オンライン/オフライン状態の監視
        window.addEventListener('online', () => {
            connectionStatus.classList.remove('offline');
            connectionStatus.classList.add('online');
            connectionText.textContent = translations[currentLang].connected || '接続済み';
            
            // オンライン復帰時にFirebase再接続を試行
            if (isRealtimeEnabled) {
                setupRealtimeListeners();
            }
        });
        
        window.addEventListener('offline', () => {
            connectionStatus.classList.remove('online');
            connectionStatus.classList.add('offline');
            connectionText.textContent = translations[currentLang].offline || 'オフライン';
        });
        
        // 初期状態設定
        if (navigator.onLine) {
            connectionStatus.classList.add('online');
            connectionText.textContent = translations[currentLang].connected || '接続済み';
        } else {
            connectionStatus.classList.add('offline');
            connectionText.textContent = translations[currentLang].offline || 'オフライン';
        }
    } else {
        connectionStatus.classList.add('offline');
        connectionText.textContent = 'ローカルモード';
    }
}
