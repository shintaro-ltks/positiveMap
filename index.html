<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Positive Map - ポジティブ感情共有アプリ</title>
    
    <!-- PWA メタタグ -->
    <meta name="theme-color" content="#6366f1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Positive Map">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- オフライン通知 -->
    <div class="offline-banner" id="offlineBanner" style="display: none;">
        📱 オフラインモード - 接続が復旧すると自動同期されます
    </div>

    <!-- 位置選択モーダル -->
    <div class="modal" id="locationModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeLocationModal()">&times;</button>
            <div class="modal-header">📍 投稿位置を選択</div>
            <p style="margin-bottom: 16px; font-size: 14px; color: var(--text-light);">
                現在地から半径100m以内の場所を選択してください
            </p>
            <div id="locationPickerMap" style="height: 200px; border-radius: 12px; overflow: hidden; border: 1px solid var(--border-color);"></div>
            <div style="margin-top: 16px; display: flex; gap: 8px;">
                <button class="btn btn-secondary" onclick="useCurrentLocation()" style="flex: 1;">現在地を使用</button>
                <button class="btn" onclick="confirmLocation()" style="flex: 1;">この位置で決定</button>
            </div>
        </div>
    </div>

    <div class="app-container">
        <div class="header">
            <div class="connection-status" id="connectionStatus">
                <span class="connection-indicator"></span>
                <span id="connectionText">接続中...</span>
            </div>
            
            <select class="lang-selector" id="langSelector">
                <option value="ja">🇯🇵 日本語</option>
                <option value="en">🇺🇸 English</option>
            </select>
            <h1 class="app-title" data-translate="app_title">Positive Map</h1>
            <p class="app-subtitle" data-translate="app_subtitle">世界中のポジティブな瞬間をリアルタイム共有</p>
        </div>

        <!-- メイン画面（マップ + 統計） -->
        <div class="screen active" id="homeScreen">
            <div class="main-content">
                <!-- リアルタイム統計 -->
                <div class="realtime-stats">
                    <button class="refresh-btn" onclick="refreshData()" title="データを更新">
                        🔄
                    </button>
                    <div class="total-posts" id="totalPosts">---</div>
                    <div class="online-users" id="onlineUsers" data-translate="users_online">🌟 みんなのポジティブ経験を共有中</div>
                </div>

                <!-- 感情別統計 -->
                <div class="stats-overview" id="statsOverview">
                    <div class="stat-card" onclick="filterByEmotion('happy')" data-emotion="happy">
                        <span class="stat-emoji">😊</span>
                        <div class="stat-number" id="happyCount">0</div>
                        <div class="stat-label" data-translate="emotion_happy">嬉しい</div>
                    </div>
                    <div class="stat-card" onclick="filterByEmotion('love')" data-emotion="love">
                        <span class="stat-emoji">❤️</span>
                        <div class="stat-number" id="loveCount">0</div>
                        <div class="stat-label" data-translate="emotion_love">愛</div>
                    </div>
                    <div class="stat-card" onclick="filterByEmotion('excited')" data-emotion="excited">
                        <span class="stat-emoji">🎉</span>
                        <div class="stat-number" id="excitedCount">0</div>
                        <div class="stat-label" data-translate="emotion_excited">興奮</div>
                    </div>
                    <div class="stat-card" onclick="filterByEmotion('grateful')" data-emotion="grateful">
                        <span class="stat-emoji">🙏</span>
                        <div class="stat-number" id="gratefulCount">0</div>
                        <div class="stat-label" data-translate="emotion_grateful">感謝</div>
                    </div>
                </div>

                <!-- インタラクティブマップ -->
                <div class="map-container">
                    <div class="map-controls">
                        <button class="map-control-btn" onclick="centerOnUser()" data-translate="center_map">現在地</button>
                        <button class="map-control-btn" onclick="showAllPosts()" data-translate="show_all">全て表示</button>
                        <button class="map-control-btn" onclick="toggleRealtime()" id="realtimeToggle">🔴 LIVE</button>
                    </div>
                    <div id="map"></div>
                </div>

                <!-- 市町村ランキング -->
                <div class="analysis-section">
                    <div class="analysis-header" data-translate="city_ranking">ポジティブ投稿の多い市町村</div>
                    <div class="analysis-content" id="cityRanking">
                        <div class="loading">
                            <div data-translate="loading_cities">市町村データを読み込み中...</div>
                        </div>
                    </div>
                </div>

                <!-- リアルタイム投稿フィード -->
                <div class="realtime-feed" id="realtimeFeed">
                    <div class="feed-header">
                        <span class="live-indicator"></span>
                        <span data-translate="live_feed">リアルタイム投稿</span>
                    </div>
                    <div id="feedList">
                        <div class="loading">
                            <div class="spinner"></div>
                            <div data-translate="loading_posts">投稿を読み込み中...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 投稿画面 -->
        <div class="screen" id="postScreen">
            <div class="main-content">
                <div class="post-form">
                    <h2 data-translate="post_title">今の気持ちを世界に投稿</h2>
                    
                    <div class="form-section">
                        <label class="form-label" data-translate="select_emotion">感情を選択してください</label>
                        <div class="emotion-grid">
                            <button class="emotion-btn" data-emotion="happy">
                                <span class="emotion-emoji">😊</span>
                                <span data-translate="emotion_happy">嬉しい</span>
                            </button>
                            <button class="emotion-btn" data-emotion="love">
                                <span class="emotion-emoji">❤️</span>
                                <span data-translate="emotion_love">愛</span>
                            </button>
                            <button class="emotion-btn" data-emotion="excited">
                                <span class="emotion-emoji">🎉</span>
                                <span data-translate="emotion_excited">興奮</span>
                            </button>
                            <button class="emotion-btn" data-emotion="grateful">
                                <span class="emotion-emoji">🙏</span>
                                <span data-translate="emotion_grateful">感謝</span>
                            </button>
                        </div>
                    </div>

                    <div class="form-section">
                        <label class="form-label" data-translate="optional_message">メッセージ（任意）</label>
                        <textarea class="form-textarea" id="postMessage" placeholder="今の気持ちを詳しく..." data-translate-placeholder="message_placeholder" maxlength="300"></textarea>
                        <div style="text-align: right; font-size: 12px; color: var(--text-light); margin-top: 4px;">
                            <span id="messageCount">0</span>/300
                        </div>
                    </div>

                    <div class="form-section">
                        <div class="location-info" id="locationInfo">
                            <div class="location-status" data-translate="getting_location">📍 位置情報を取得中...</div>
                            <div class="coordinates" id="coordinates"></div>
                            <div class="location-controls">
                                <button class="location-btn" onclick="openLocationPicker()" data-translate="select_location">位置を選択</button>
                                <button class="location-btn secondary" onclick="getUserLocationManual()" data-translate="use_current">現在地を使用</button>
                            </div>
                        </div>
                    </div>

                    <button class="btn" id="submitPostBtn" onclick="submitPost()" disabled data-translate="post_button">世界に投稿する</button>
                </div>
            </div>
        </div>

        <!-- プロファイル画面 -->
        <div class="screen" id="profileScreen">
            <div class="main-content">
                <div class="profile-header">
                    <div class="profile-avatar">😊</div>
                    <div class="user-stats">
                        <div class="user-stat">
                            <div class="user-stat-number" id="userPostCount">0</div>
                            <div class="user-stat-label" data-translate="posts">投稿</div>
                        </div>
                        <div class="user-stat">
                            <div class="user-stat-number" id="userDays">0</div>
                            <div class="user-stat-label" data-translate="days">日間</div>
                        </div>
                        <div class="user-stat">
                            <div class="user-stat-number" id="userCountries">1</div>
                            <div class="user-stat-label" data-translate="countries">国</div>
                        </div>
                    </div>
                </div>

                <div class="settings-form">
                    <h3 data-translate="user_settings" style="margin-bottom: 16px;">ユーザー設定</h3>
                    
                    <div class="form-row">
                        <div>
                            <label class="form-label" data-translate="age_group">年齢層</label>
                            <select class="form-select" id="ageGroup" onchange="saveProfile()">
                                <option value="" data-translate="select_age">選択してください</option>
                                <option value="12-">12歳以下</option>
                                <option value="13-18">13-18歳</option>
                                <option value="19-25">19-25歳</option>
                                <option value="26-35">26-35歳</option>
                                <option value="36-45">36-45歳</option>
                                <option value="46-55">46-55歳</option>
                                <option value="56-65">56-65歳</option>
                                <option value="66+">66歳以上</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label" data-translate="country">居住国</label>
                            <select class="form-select" id="userCountry" onchange="saveProfile()">
                                <option value="" data-translate="select_country">選択してください</option>
                                <option value="Japan">🇯🇵 日本</option>
                                <option value="United States">🇺🇸 アメリカ</option>
                                <option value="United Kingdom">🇬🇧 イギリス</option>
                                <option value="France">🇫🇷 フランス</option>
                                <option value="Germany">🇩🇪 ドイツ</option>
                                <option value="China">🇨🇳 中国</option>
                                <option value="South Korea">🇰🇷 韓国</option>
                                <option value="Spain">🇪🇸 スペイン</option>
                                <option value="Italy">🇮🇹 イタリア</option>
                                <option value="Australia">🇦🇺 オーストラリア</option>
                                <option value="Canada">🇨🇦 カナダ</option>
                                <option value="Brazil">🇧🇷 ブラジル</option>
                                <option value="India">🇮🇳 インド</option>
                                <option value="Other">🌍 その他</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 投稿履歴 -->
                <div class="analysis-section">
                    <div class="analysis-header" data-translate="post_history">投稿履歴</div>
                    <div class="analysis-content" id="historyList">
                        <div class="loading">
                            <div data-translate="no_posts">まだ投稿がありません</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- データ分析画面 -->
        <div class="screen" id="dataScreen">
            <div class="main-content">
                <h2 data-translate="data_analytics" style="margin-bottom: 16px; font-size: 20px;">データ分析</h2>
                
                <!-- 全体統計 -->
                <div class="realtime-stats">
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; text-align: center;">
                        <div>
                            <div style="font-size: 24px; font-weight: 700;" id="totalUsers">---</div>
                            <div style="font-size: 12px; opacity: 0.8;" data-translate="total_users">総ユーザー数</div>
                        </div>
                        <div>
                            <div style="font-size: 24px; font-weight: 700;" id="countriesCount">---</div>
                            <div style="font-size: 12px; opacity: 0.8;" data-translate="countries_represented">参加国数</div>
                        </div>
                    </div>
                </div>

                <!-- 年齢層別分析 -->
                <div class="analysis-section">
                    <div class="analysis-header" data-translate="age_analysis">年齢層別分析</div>
                    <div class="analysis-content" id="ageAnalysis">
                        <div class="loading">
                            <div data-translate="analyzing_data">データを分析中...</div>
                        </div>
                    </div>
                </div>

                <!-- 国別分析 -->
                <div class="analysis-section">
                    <div class="analysis-header" data-translate="country_analysis">国別分析</div>
                    <div class="analysis-content" id="countryAnalysis">
                        <div class="loading">
                            <div data-translate="loading_countries">国別データを読み込み中...</div>
                        </div>
                    </div>
                </div>

                <!-- 時間別分析 -->
                <div class="analysis-section">
                    <div class="analysis-header" data-translate="hourly_analysis">時間別分析</div>
                    <div class="analysis-content">
                        <div class="chart-container" id="hourlyChart">
                            <!-- チャートがここに動的に生成される -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- フローティング投稿ボタン -->
        <button class="floating-btn" onclick="showScreen('postScreen')" id="floatingPostBtn">+</button>

        <!-- ナビゲーション -->
        <div class="navigation">
            <button class="nav-btn active" onclick="showScreen('homeScreen')">
                <span class="nav-icon">🗺️</span>
                <span class="nav-label" data-translate="nav_map">マップ</span>
            </button>
            <button class="nav-btn" onclick="showScreen('postScreen')">
                <span class="nav-icon">✏️</span>
                <span class="nav-label" data-translate="nav_post">投稿</span>
            </button>
            <button class="nav-btn" onclick="showScreen('profileScreen')">
                <span class="nav-icon">👤</span>
                <span class="nav-label" data-translate="nav_profile">プロフィール</span>
            </button>
            <button class="nav-btn" onclick="showScreen('dataScreen')">
                <span class="nav-icon">📊</span>
                <span class="nav-label" data-translate="nav_data">データ</span>
            </button>
        </div>
    </div>

    <!-- Leaflet JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    
    <!-- Custom JavaScript -->
    <script src="script.js"></script>
</body>
</html>
